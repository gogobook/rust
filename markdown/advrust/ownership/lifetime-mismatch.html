<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>生命周期限制</title>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        
    </head>
    <body class="vscode-light">
        <h1 id="%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e9%99%90%e5%88%b6">生命周期限制</h1>
<blockquote>
<p>原文跟踪<a href="https://github.com/rust-lang-nursery/nomicon/blob/master/src/lifetime-mismatch.md">lifetime-mismatch.md</a>   Commit: d870b6788ba078ba398f020305ef9210f7cbd740</p>
</blockquote>
<p>给出以下代码：</p>
<pre><code class="language-rust"><div><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Foo</span></span>;

<span class="hljs-keyword">impl</span> Foo {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">mutate_and_share</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) -&gt; &amp;<span class="hljs-keyword">Self</span> { &amp;*<span class="hljs-keyword">self</span> }
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">share</span></span>(&amp;<span class="hljs-keyword">self</span>) {}
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> foo = Foo;
    <span class="hljs-keyword">let</span> loan = foo.mutate_and_share();
    foo.share();
}
</div></code></pre>
<p>人们可能期望它能够编译。我们称之为mutate_and_share临时借用 foo，但后来只返回共享引用。因此，我们期望foo.share()成功，因为foo不应该可变地借用。</p>
<p>但是当我们尝试编译它时：</p>
<pre><code class="language-rust"><div>error[E0502]: cannot borrow `foo` <span class="hljs-keyword">as</span> immutable because it is also borrowed <span class="hljs-keyword">as</span> mutable
  --&gt; src/lib.rs:<span class="hljs-number">11</span>:<span class="hljs-number">5</span>
   |
<span class="hljs-number">10</span> |     <span class="hljs-keyword">let</span> loan = foo.mutate_and_share();
   |                --- mutable borrow occurs here
<span class="hljs-number">11</span> |     foo.share();
   |     ^^^ immutable borrow occurs here
<span class="hljs-number">12</span> | }
   | - mutable borrow ends here
</div></code></pre>
<p>发生了什么？好吧，我们得到以下内容：</p>
<pre><code class="language-rust"><div><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Foo</span></span>;

<span class="hljs-keyword">impl</span> Foo {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">mutate_and_share</span></span>&lt;<span class="hljs-symbol">'a</span>&gt;(&amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) -&gt; &amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">Self</span> { &amp;<span class="hljs-symbol">'a</span> *<span class="hljs-keyword">self</span> }
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">share</span></span>&lt;<span class="hljs-symbol">'a</span>&gt;(&amp;<span class="hljs-symbol">'a</span> <span class="hljs-keyword">self</span>) {}
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-symbol">'b</span>: {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> foo: Foo = Foo;
        <span class="hljs-symbol">'c</span>: {
            <span class="hljs-keyword">let</span> loan: &amp;<span class="hljs-symbol">'c</span> Foo = Foo::mutate_and_share::&lt;<span class="hljs-symbol">'c</span>&gt;(&amp;<span class="hljs-symbol">'c</span> <span class="hljs-keyword">mut</span> foo);
            <span class="hljs-symbol">'d</span>: {
                Foo::share::&lt;<span class="hljs-symbol">'d</span>&gt;(&amp;<span class="hljs-symbol">'d</span> foo);
            }
        }
    }
}
</div></code></pre>
<p>由于<code>loan</code>的生命周期和<code>mutate_and_share</code>的签名, 生命周期系统强制扩展<code>&amp;mut foo</code>的生命周期为<code>'c</code>，然后当我们试着调用<code>share</code>的时候，它说我们正试图别名<code>&amp;'c mut foo</code>！</p>
<p>根据我们实际关注的引用语义，这个程序显然是正确的，但是生命周期系统太粗糙而无法处理。</p>

    </body>
    </html>