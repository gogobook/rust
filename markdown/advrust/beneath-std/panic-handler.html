<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>#[panic_handler]</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        <link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
    </head>
    <body class="vscode-light">
        <h1 id="panichandler">#[panic_handler]</h1>
<blockquote>
<p>原文跟踪<a href="https://github.com/rust-lang-nursery/nomicon/blob/master/src/panic-handler.md">panic-handler.md</a>   Commit: 676e7d1aaa82fa9e1ba4de789ca904c6c0cda8d6</p>
</blockquote>
<p><code>＃[panic_handler]</code>用于定义<code>＃！[no_std]</code>应用程序中<code>panic！</code>的行为。<code>＃[panic_handler]</code>属性必须应用于具有签名`fn（＆PanicInfo）的函数</p>
<ul>
<li>
<blockquote>
<p>！`这样的函数必须出现<strong>once</strong>在二进制/ dylib / cdylib的依赖图中。</p>
</blockquote>
</li>
</ul>
<p>鉴于<code>＃！[no_std]</code>应用程序没有标准输出在一些<code>＃！[no_std]</code>应用，例如嵌入式应用程序，需要不同的恐慌行为进行开发和使用释放它可能有助于恐慌<code>crates</code>，只包含一个<code>＃[panic_handler]</code>。这样，应用程序可以通过简单地链接到不同的恐慌<code>crate</code>来轻松交换恐慌行为。</p>
<p>下面显示了一个示例，其中应用程序具有不同的恐慌行为，具体取决于是使用dev配置文件（<code>cargo build</code>）编译还是使用发布配置文件（<code>cargo build --release</code>）</p>
<pre><code class="language-rust"><div><span class="hljs-comment">// crate: panic-semihosting -- log panic messages to the host stderr using semihosting</span>

<span class="hljs-meta">#![no_std]</span>

<span class="hljs-keyword">use</span> core::fmt::{Write, <span class="hljs-keyword">self</span>};
<span class="hljs-keyword">use</span> core::panic::PanicInfo;

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HStderr</span></span> {
    <span class="hljs-comment">// ..</span>
    _0: (),
}

<span class="hljs-keyword">impl</span> HStderr {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>() -&gt; HStderr { HStderr { _0: () } }
}

<span class="hljs-keyword">impl</span> fmt::Write <span class="hljs-keyword">for</span> HStderr {
    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">write_str</span></span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _: &amp;<span class="hljs-built_in">str</span>) -&gt; fmt::<span class="hljs-built_in">Result</span> { <span class="hljs-literal">Ok</span>(()) }
}

<span class="hljs-meta">#[panic_handler]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">panic</span></span>(info: &amp;PanicInfo) -&gt; ! {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> host_stderr = HStderr::new();

    <span class="hljs-comment">// logs "panicked at '$reason', src/main.rs:27:4" to the host stderr</span>
    <span class="hljs-built_in">writeln!</span>(host_stderr, <span class="hljs-string">"{}"</span>, info).ok();

    <span class="hljs-keyword">loop</span> {}
}
</div></code></pre>
<pre><code class="language-rust"><div><span class="hljs-comment">// crate: panic-halt -- halt the thread on panic; messages are discarded</span>

<span class="hljs-meta">#![no_std]</span>

<span class="hljs-keyword">use</span> core::panic::PanicInfo;

<span class="hljs-meta">#[panic_handler]</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">panic</span></span>(_info: &amp;PanicInfo) -&gt; ! {
    <span class="hljs-keyword">loop</span> {}
}
</div></code></pre>
<pre><code class="language-rust"><div><span class="hljs-comment">// crate: app</span>

<span class="hljs-meta">#![no_std]</span>

<span class="hljs-comment">// dev profile</span>
<span class="hljs-meta">#[cfg(debug_assertions)]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> panic_semihosting;

<span class="hljs-comment">// release profile</span>
<span class="hljs-meta">#[cfg(not(debug_assertions))]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> panic_halt;

<span class="hljs-comment">// omitted: other `extern crate`s</span>

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-comment">// ..</span>
}
</div></code></pre>

    </body>
    </html>